gai() (
  set -euo pipefail

  # Must be in a repo
  if ! command git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Not inside a git repository."
    exit 1
  fi

  # Must have staged changes
  if command git diff --cached --quiet; then
    echo "No staged changes."
    exit 1
  fi

  # Show staged diff
  # Uncomment to show diff in pager before prompt
  # command git -c pager.diff=true diff --cached
  # echo

  # Build prompt
  staged_names="$(command git diff --cached --name-status --no-color)"
  staged_stat="$(command git diff --cached --stat --no-color)"

  prompt="$(
    cat <<'PROMPT'
Output MUST be exactly ONE line and NOTHING ELSE.

Write a Conventional Commits SUBJECT line for the staged changes.

Hard rules:
- Format: type(scope?): subject
- type must be one of: feat fix refactor docs test chore perf ci build style revert
- subject length <= 72 characters
- No preamble, no questions, no quotes, no markdown, no bullets, no stats/cost/model info.

Staged files:
PROMPT
  )"

  prompt="${prompt}
${staged_names}

Diffstat:
${staged_stat}
"

  echo "Generating commit message..."

  msg="$(gh copilot -- -s -p "$prompt" 2>/dev/null || true)"

  msg="$(
    printf "%s\n" "$msg" |
      awk 'NF {print; exit}' |
      sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//; s/^["'\''`]+//; s/["'\''`]+$//'
  )"

  if ! printf "%s\n" "$msg" | grep -Eq '^(feat|fix|refactor|docs|test|chore|perf|ci|build|style|revert)(\([^)]+\))?: .+$'; then
    echo "Copilot output does not look like a conventional commit subject:"
    printf "%s\n" "$msg" >&2
    echo
    printf "Enter commit subject manually (blank cancels): "
    read msg
    msg="$(printf "%s\n" "$msg" | awk 'NF {print; exit}')"
    [ -z "$msg" ] && echo "Cancelled." && exit 0
  fi

  echo
  echo "Proposed commit subject:"
  echo "  $msg"
  echo

  read ans\?"Commit with this message? [Y/n] "
  case "${ans:-Y}" in
    Y|y|yes|YES)
      command git commit -m "$msg"
      ;;
    N|n|no|NO)
      echo "Cancelled."
      exit 0
      ;;
    *)
      echo "Cancelled."
      exit 1
      ;;
  esac
)
